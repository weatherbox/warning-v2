{"version":3,"sources":["SelectedLayer.js","PossibilityLayer.js","Warning.js","Map.js","App.js","index.js"],"names":["SelectedLayer","map","onSelected","_this","this","Object","classCallCheck","addSelectedLayer","on","e","onClick","_addSelectedLayer","type","addLayer","id","source","source-layer","paint","line-color","line-width","filter","features","console","log","properties","_this$getCode","getCode","code","prefName","name","selectPref","codes","_this2","forEach","l","setFilter","concat","toConsumableArray","PossibilityLayer","data","hover","queryRenderedFeatures","point","layers","getCanvas","style","cursor","length","weatherInfo","prefs","popup","remove","addSource","minzoom","maxzoom","tiles","renderAll","selectedLayer","mapboxgl","Popup","closeButton","stops","all","rank","push","getColor","fill-color","property","default","高","中","WeatherInfo","state","info","sidebar","showPref","loadWeatherInfo","timestamp","Date","getTime","fetch","url","mode","then","res","json","setState","layer","Component","accessToken","Map","container","mapContainer","zoom","center","hash","attributionControl","child","onload","react_default","a","createElement","className","ref","el","Warning_WeatherInfo","App","Map_Map","ReactDOM","render","src_App","document","getElementById"],"mappings":"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","file":"static/js/main.1d4620f9.chunk.js","sourcesContent":["export default class SelectedLayer {\n  constructor(map, onSelected) {\n    this.map = map;\n    this.onSelected = onSelected;\n\n    this.addSelectedLayer();\n    this.map.on('click', 'weather-info-pref', (e) => {\n      this.onClick(e);\n    });\n  }\n\n  addSelectedLayer() {\n    this._addSelectedLayer('pref');\n    this._addSelectedLayer('distlict');\n    this._addSelectedLayer('region');\n  }\n  \n  _addSelectedLayer(type) {\n    this.map.addLayer({\n      \"id\": type + \"-line-selected\",\n      \"type\": \"line\",\n      \"source\": type === \"region\" ? \"region-vt\" : \"vt\",\n      \"source-layer\": type,\n      \"paint\": {\n        \"line-color\": \"rgba(70, 171, 199, 0.8)\",\n        \"line-width\": 1\n      },\n      filter: [\"==\", \"code\", \"0\"]\n    });\n  }\n\n  onClick(e) {\n    if (e.features) {\n      console.log(e.features[0].properties);\n      const { code, name } = this.getCode(e.features[0].properties.code);\n      const prefName = name || e.features[0].properties.name;\n      this.selectPref(code);\n      this.onSelected(code, prefName);\n    }\n  }\n  \n  select(type, codes) {\n    ['pref', 'distlict', 'region'].forEach(l => {\n      const filter = l === type ? codes : ['0'];\n      this.map.setFilter(l + '-line-selected', ['in', 'code', ...filter]);\n    });\n  }\n}\n","import mapboxgl from 'mapbox-gl';\nimport SelectedLayer from './SelectedLayer';\n\n\nexport default class PossibilityLayer {\n  constructor(map, data, onSelected) {\n    this.map = map;\n    this.data = data;\n\n    this.map.addSource(\"vt\", {\n      \"type\": \"vector\",\n      \"minzoom\": 0,\n      \"maxzoom\": 10,\n      \"tiles\": [\"https://weatherbox.github.io/warning-area-vt/v2/{z}/{x}/{y}.pbf\"]\n    });\n\n    this.map.addLayer({\n      \"id\": \"pref-line\",\n      \"type\": \"line\",\n      \"source\": \"vt\",\n      \"source-layer\": \"pref\",\n      \"paint\": {\n        \"line-color\": \"rgba(55, 55, 55, 0.4)\"\n      }\n    });\n    this.renderAll();\n    this.selectedLayer =  new SelectedLayer(map, onSelected);\n\n    this.popup = new mapboxgl.Popup({\n      closeButton: false\n    });\n    this.map.on('mousemove', this.hover);\n  }\n\n  renderAll() {\n    const stops = [];\n\n    for (let code in this.data.all) {\n      const rank = this.data.all[code];\n      if (rank) stops.push([code, this.getColor(rank)]);\n    }\n\n    this.map.addLayer({\n      \"id\": \"possibility-all\",\n      \"type\": \"fill\",\n      \"source\": \"vt\",\n      \"source-layer\": \"distlict\",\n      \"paint\": {\n        \"fill-color\": {\n          \"property\": \"code\",\n          \"type\": \"categorical\",\n          \"stops\": stops,\n          \"default\": \"rgba(0, 0, 0, 0)\"\n        },\n      }\n    });\n  }\n\n\n  getColor(rank) {\n    const colors = {\n      '高': 'rgba(253, 108, 112, 0.5)',\n      '中':  'rgba(253, 188, 172, 0.4)'\n    };\n    return colors[rank];\n  }\n\n  hover = (e) => {\n    const features = this.map.queryRenderedFeatures(e.point, { layers: [] });\n    this.map.getCanvas().style.cursor = (features.length) ? 'crosshair' : '';\n\n    let html;\n    if (features.length) {\n      const code = this.getCode(features[0].properties.code);\n      const infos = this.weatherInfo.prefs[code];\n      if (infos) {\n      }\n    }\n    \n    if (html) {\n      this.popup.setLngLat(e.lngLat)\n        .setHTML(html)\n        .addTo(this.map);\n    } else {\n      this.popup.remove();\n    }\n  }\n  \n}\n","import React, { Component } from 'react';\n\n//import Sidebar from './Sidebar';\nimport PossibilityLayer from './PossibilityLayer';\n\nconst url = 'https://storage.googleapis.com/weather-warning/possibility.json';\n\nexport default class WeatherInfo extends Component {\n  state = {\n    info: null,\n  };\n\n  componentDidMount() {\n    this.loadWeatherInfo();\n  }\n\n  onload(map) {\n    this.map = map;\n    this.addLayer();\n  }\n  \n  loadWeatherInfo() {\n    const timestamp = new Date().getTime();\n    fetch(url + '?' + timestamp, {mode: 'cors'})\n      .then(res => res.json())\n      .then(data => {\n        console.log(data);\n        this.setState({ info: data });\n        this.data = data;\n        this.addLayer();\n      });\n  }\n\n  addLayer() {\n    if (!this.map || !this.data) return;\n    this.layer = new PossibilityLayer(this.map, this.data, this.onSelected);\n  }\n\n  render() {\n    return null;\n    /*\n    return (\n      <Sidebar\n        data={this.state.info}\n        ref={el => this.sidebar = el}\n      />\n    );\n    */\n  }\n\n  onSelected = (code, prefName) => {\n    this.sidebar.showPref(code, prefName);\n  }\n}\n","import React, { Component } from 'react';\nimport mapboxgl from 'mapbox-gl';\nimport 'mapbox-gl/dist/mapbox-gl.css'\n\nimport Warning from './Warning';\nimport './Map.css';\n\nmapboxgl.accessToken = 'pk.eyJ1IjoidGF0dGlpIiwiYSI6ImNqZWZ4eWM3NTI2cGszM2xpYXEyZndpd3IifQ.ifzbR45HecVGxChbdR2hiw';\n\n\nexport default class Map extends Component {\n  componentDidMount() {\n    this.map = new mapboxgl.Map({\n      container: this.mapContainer,\n      style: 'mapbox://styles/tattii/cj1bob6hw003t2rr5s2svi3iq',\n      zoom: 4.2,\n      center: [136.6 + 10, 35.5],\n      hash: true,\n      attributionControl: false\n    });\n\n    this.map.on('load', () => {\n      this.child.onload(this.map);\n    });\n  }\n\n  render() {\n    return (\n      <div className=\"app\">\n        <div ref={el => this.mapContainer = el} id=\"map\" />\n        <Warning\n          ref={ref => this.child = ref}\n        />\n      </div>\n    )\n  }\n}\n","import React, { Component } from 'react';\n\nimport Map from './Map';\n\nclass App extends Component {\n  render() {\n    return (\n      <Map />\n    );\n  }\n}\n\nexport default App;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(<App />, document.getElementById('app'));\n\n"],"sourceRoot":""}